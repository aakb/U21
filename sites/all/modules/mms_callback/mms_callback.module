<?php

/**
 * Implementation of hook_menu().
 */
function mms_callback_menu() {
  $items = array();

  $items['callback/upload/mms'] = array(
    'title' => 'MMS callback',
    'page callback' => 'mms_callback_message',
    'access callback' => TRUE,
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}


function mms_callback_message() {
  // Try to get the XML callback information
  if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $postText = file_get_contents('php://input');
  }
  else {
    // No information found
    watchdog('MMS Callback', t('Callback received but no data found in message.'), NULL, WATCHDOG_ERROR);
    return FALSE;
  }

  // Parse XML message
  $xml = new SimpleXMLElement($postText);
  if (!$xml) {
    watchdog('MMS Callback', t('The XML could not be parsed.'), NULL, WATCHDOG_ERROR);
    return FALSE;
  }
  
  // Get text
  $text = file_get_contents($xml->text);

  // Create folder and download image
  $image = file_directory_path() . '/mms_images';
  if (file_check_directory($image, FILE_CREATE_DIRECTORY)) {
    $image .= '/' . basename($xml->image);
    file_put_contents($img, file_get_contents($xml->image));
  }
  else {
    watchdog('MMS Callback', t('Could not create folder inside files folder.'), NULL, WATCHDOG_ERROR);
    return FALSE;
  }

  // Save information to the database
  $record = new stdClass();
  $record->msgid = $xml->msgid;
  $record->message = $text;
  $record->image = $image;
  drupal_write_record('mms_callback', $record);
}